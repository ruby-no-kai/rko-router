daemon off;
#Heroku dynos have 4 cores.
worker_processes 4;

events {
  use epoll;
  accept_mutex on;
  worker_connections 1024;
}

http {
  gzip on;
  gzip_comp_level 2;
  gzip_min_length 512;

  log_format l2met 'measure#nginx.service=$request_time request_id=$http_x_request_id '
    '$http_x_forwarded_for - $remote_user [$time_local] '
    '"$request" $status $bytes_sent '
    '"$http_referer" "$http_user_agent" "$gzip_ratio"';
  access_log logs/nginx/access.log l2met;
  error_log logs/nginx/access.log;

  include mime.types;
  default_type application/octet-stream;
  sendfile on;

  #Must read the body in 5 seconds.
  client_body_timeout 5;

  port_in_redirect off;

  proxy_ssl_server_name on;

  rewrite_log <%= ENV.fetch("REWRITE_LOG", 'off') %>;

  server {
    listen <%= ENV["PORT"] %> default_server;
    server_name rko-router.herokuapp.com;

    default_type text/plain;

    location = / {
      return 200 "rko-router";
    }

    location / {
      return 404 "four-oh-four";
    }
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name regional.rubykaigi.org;


    location ~ ^/oedo03(.*) {
      proxy_pass http://oedo03.herokuapp.com;
#       rewrite ^/oedo03(.*)$ http://oedo03.herokuapp.com/oedo03$1 permanent;
    }

    location ~ ^/osaka01(.*) {
      proxy_pass https://rubykansai.github.io;
    }

    location ~ ^/kansai2017(.*) {
      proxy_pass https://rubykansai.github.io;
    }

    #
    # kansai 06, y10y
    #
    location ~ ^/kansai06(.*) {
      proxy_pass https://rubykansai.github.io;
    }

    #
    # kansai 05, y10y
    #
    location ~ ^/kansai05(.*) {
      proxy_pass http://kanrk05.herokuapp.com;
    }

    #
    # chuork 01, y6y
    #
    location ~ ^/chuork01(.*) {
      proxy_pass https://chuork.github.io;
    }

    #
    # okrk01, y6y
    #
    location ~ ^/okrk01(.*) {
      proxy_pass https://okinawarb.github.io;
    }

    #
    # shibuya01, y6y
    #
    location ~ ^/shibuya01(.*) {
    proxy_pass https://shibuyarb.github.io;
    }

    #
    # tokyu12, y6y
    #
    location ~ ^/tokyu12(.*) {
      proxy_pass https://tokyurubykaigi.github.io;
    }

    #
    # tokyu11, y6y
    #
    location ~ ^/tokyu11(.*) {
      proxy_pass https://tokyurubykaigi.github.io;
    }

    #
    # tokyu09, y6y
    #
    location ~ ^/tokyu09(.*) {
      proxy_pass https://tokyurubykaigi.github.io;
    }

    #
    # tokyu08, y6y
    #
    location ~ ^/tokyu08(.*) {
    proxy_pass https://tokyurb.github.io;
    }

    #
    # kanagawa01, y6y
    #
    location ~ ^/kana01(.*) {
    proxy_pass https://kawasakirb.github.io;
    }

    location ~ ^/oedo04(.*) {
    proxy_pass http://oedo04.herokuapp.com;
    }

    location ~ ^/hamamatsu01(.*) {
    proxy_pass http://rubykaigi-hamamatsu.s3-website-ap-northeast-1.amazonaws.com;
    }

    location ~ ^/(matrk|matsue)08(.*) {
      return 301 http://matsue.rubyist.net/matrk08/;
    }

    location ~ ^/(matrk|matsue)07(.*) {
      return 301 http://matsue.rubyist.net/matrk07/;
    }

    location ~ ^/oedo05(.*) {
     proxy_pass https://asakusarb.github.io;
    }

    location ~ ^/oedo06(.*) {
     proxy_pass https://asakusarb.github.io;
    }

    location ~ ^/tokyo11(.*) {
     proxy_pass https://ko1.github.io;
    }

    location ~ ^/tokyu10(.*) {
      proxy_pass https://tokyurubykaigi.github.io;
    }

    location ~ ^/kwsk01(.*) {
      proxy_pass https://kawasakirb.github.io;
    }

    # regional.rubykairi.org
    location / {
      proxy_set_header Host regional-gh.rubykaigi.org;
      proxy_pass https://regional-gh.rubykaigi.org;
    }
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name j.rubykaigi.org;
    rewrite ^ http://jrubykaigi.org$request_uri permanent;
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name yami.rubykaigi.org;

    location = / {
      return 302 http://yami.rubykaigi.org/2011;
    }

    location ~ /2011 {
      return 301 http://yamirubykaigi.wordpress.com;
    }
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name  rubykaigi.org www.rubykaigi.org ~^200[6-8]\.rubykaigi\.org$;

    rewrite_log <%= ENV.fetch("REWRITE_LOG", 'off') %>;

    if ($host ~* www\.(.*)) {
      set $host_without_www $1;
      rewrite ^(.*)$ http://$host_without_www permanent;
    }

    if ($host ~* (200[6-8])\.(.*)) {
      set $rubykaigi_year $1;
      rewrite ^(.*)$ http://jp.rubyist.net/RubyKaigi$rubykaigi_year permanent;
    }

    location ~ ^/(200[6-8])(.*) {
        set $rubykaigi_year $1;
        rewrite ^(.*)$ http://jp.rubyist.net/RubyKaigi$rubykaigi_year permanent;
    }

    location ~ ^/2009(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/2010(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/2011(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/2012(.*) {
        # for 404 kaigi not found
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/assets/(20[1-9][3-9]) {
        rewrite ^/assets/(20[1-9][3-9])(.*)$ http://rubykaigi$1.herokuapp.com/assets/$1$2;
    }

    location ~ ^/2013(.*) {
        proxy_pass http://rubykaigi2013.herokuapp.com;
    }

    location ~ ^/2014(.*) {
        proxy_pass http://rubykaigi2014.herokuapp.com;
    }

    location ~ ^/2015(.*) {
        proxy_pass http://rubykaigi2015.herokuapp.com;
    }

    location ~ ^/2016(.*) {
        proxy_pass http://rk2016.herokuapp.com;
    }

    location ~ ^/2017(.*) {
        proxy_pass http://rubykaigi2017.herokuapp.com;
    }

    location ~ ^/2018(.*) {
        proxy_pass http://rubykaigi2018.herokuapp.com;
    }

    location ~ ^/2019(.*) {
        proxy_pass http://rubykaigi2019.herokuapp.com;
    }

    location ~ ^/\.2006(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/\.2007(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~ ^/\.2008(.*) {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    # current rubykaigi
    location = / {
        return 302 http://rubykaigi.org/2018;
    }

    location ~* /([0-9][0-9][0-9][0-9])?(images|javascripts|stylehseets)/ {
        proxy_pass http://2009-2011.rubykaigi.org;
    }

    location ~* .ico$ {
        proxy_pass http://2009-2011.rubykaigi.org;
    }
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name sapporo.rubykaigi.org;
    location / {
      proxy_set_header Host $host;
      proxy_pass https://ruby-sapporo.github.io;
    }
  }

  server {
    listen <%= ENV["PORT"] %>;
    server_name cfp.rubykaigi.org;
    location / {
      return 302 https://rubykaigi-cfp.herokuapp.com;
    }
  }

  # sponsorship application form for rubykaigi 2018.
  server {
    listen <%= ENV["PORT"] %>;
    server_name sponsorship.rubykaigi.org sponsorships.rubykaigi.org;
    location / {
      return 302 https://docs.google.com/forms/d/e/1FAIpQLSfkgH_vh_qu-KJN-w7zJOKtHKginbTSB_8fqzOlcqm9wOJtxw/viewform;
    }
  }
}
